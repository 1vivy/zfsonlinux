From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: LOLi <loli10K@users.noreply.github.com>
Date: Sun, 17 Dec 2017 23:08:48 +0100
Subject: [PATCH] Fix --with-systemd on Debian-based distributions (#6963)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

These changes propagate the "--with-systemd" configure option to the
RPM spec file, allowing Debian-based distributions to package
systemd-related files.

Signed-off-by: Brian Behlendorf <behlendorf1@llnl.gov>
Signed-off-by: loli10K <ezomori.nozomu@gmail.com>
Closes #6591
Closes #6963
(cherry picked from commit 03658d5081c64e14898cc9be45da3305b27fac9e)
Signed-off-by: Fabian Gr√ºnbichler <f.gruenbichler@proxmox.com>
---
 rpm/generic/zfs.spec.in |  2 +-
 config/user-systemd.m4  | 20 ++++++++++++++++----
 config/zfs-build.m4     |  2 +-
 3 files changed, 18 insertions(+), 6 deletions(-)

diff --git a/rpm/generic/zfs.spec.in b/rpm/generic/zfs.spec.in
index 8df57fa46..4a911b4c2 100644
--- a/rpm/generic/zfs.spec.in
+++ b/rpm/generic/zfs.spec.in
@@ -87,11 +87,11 @@ BuildRequires:  libblkid-devel
 BuildRequires:  libudev-devel
 BuildRequires:  libattr-devel
 %endif
+
 %if 0%{?_systemd}
 Requires(post): systemd
 Requires(preun): systemd
 Requires(postun): systemd
-BuildRequires: systemd
 %endif
 
 # The zpool iostat/status -c scripts call some utilities like lsblk and iostat
diff --git a/config/user-systemd.m4 b/config/user-systemd.m4
index c2105abce..de2a44f10 100644
--- a/config/user-systemd.m4
+++ b/config/user-systemd.m4
@@ -2,7 +2,8 @@ AC_DEFUN([ZFS_AC_CONFIG_USER_SYSTEMD], [
 	AC_ARG_ENABLE(systemd,
 		AC_HELP_STRING([--enable-systemd],
 		[install systemd unit/preset files [[default: yes]]]),
-		[],enable_systemd=yes)
+		[enable_systemd=$enableval],
+		[enable_systemd=check])
 
 	AC_ARG_WITH(systemdunitdir,
 		AC_HELP_STRING([--with-systemdunitdir=DIR],
@@ -19,16 +20,27 @@ AC_DEFUN([ZFS_AC_CONFIG_USER_SYSTEMD], [
 		[install systemd module load files into dir [[/usr/lib/modules-load.d]]]),
 		systemdmoduleloaddir=$withval,systemdmodulesloaddir=/usr/lib/modules-load.d)
 
+	AS_IF([test "x$enable_systemd" = xcheck], [
+		AS_IF([systemctl --version >/dev/null 2>&1],
+			[enable_systemd=yes],
+			[enable_systemd=no])
+	])
 
-	AS_IF([test "x$enable_systemd" = xyes],
-		[
+	AC_MSG_CHECKING(for systemd support)
+	AC_MSG_RESULT([$enable_systemd])
+
+	AS_IF([test "x$enable_systemd" = xyes], [
 		ZFS_INIT_SYSTEMD=systemd
 		ZFS_MODULE_LOAD=modules-load.d
+		DEFINE_SYSTEMD='--with systemd --define "_unitdir $(systemdunitdir)" --define "_presetdir $(systemdpresetdir)"'
 		modulesloaddir=$systemdmodulesloaddir
-		])
+	],[
+		DEFINE_SYSTEMD='--without systemd'
+	])
 
 	AC_SUBST(ZFS_INIT_SYSTEMD)
 	AC_SUBST(ZFS_MODULE_LOAD)
+	AC_SUBST(DEFINE_SYSTEMD)
 	AC_SUBST(systemdunitdir)
 	AC_SUBST(systemdpresetdir)
 	AC_SUBST(modulesloaddir)
diff --git a/config/zfs-build.m4 b/config/zfs-build.m4
index 17cc80462..5eaa49c87 100644
--- a/config/zfs-build.m4
+++ b/config/zfs-build.m4
@@ -160,7 +160,7 @@ AC_DEFUN([ZFS_AC_RPM], [
 	])
 
 	RPM_DEFINE_COMMON='--define "$(DEBUG_ZFS) 1"'
-	RPM_DEFINE_UTIL='--define "_dracutdir $(dracutdir)" --define "_udevdir $(udevdir)" --define "_udevruledir $(udevruledir)" --define "_initconfdir $(DEFAULT_INITCONF_DIR)" $(DEFINE_INITRAMFS)'
+	RPM_DEFINE_UTIL='--define "_dracutdir $(dracutdir)" --define "_udevdir $(udevdir)" --define "_udevruledir $(udevruledir)" --define "_initconfdir $(DEFAULT_INITCONF_DIR)" $(DEFINE_INITRAMFS) $(DEFINE_SYSTEMD)'
 	RPM_DEFINE_KMOD='--define "kernels $(LINUX_VERSION)" --define "require_spldir $(SPL)" --define "require_splobj $(SPL_OBJ)" --define "ksrc $(LINUX)" --define "kobj $(LINUX_OBJ)"'
 	RPM_DEFINE_DKMS=
 
-- 
2.14.2

