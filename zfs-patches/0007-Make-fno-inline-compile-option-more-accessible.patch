From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Prakash Surya <prakash.surya@delphix.com>
Date: Fri, 15 Sep 2017 11:47:11 -0700
Subject: [PATCH] Make "-fno-inline" compile option more accessible
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

When functions are inlined, it can make the system much more difficult
to instrument using tools such as ftrace, BPF, crash, etc. Thus, to aid
development and increase the system's observability, when the
"--enable-debuginfo" flag is specified, the "-fno-inline" compilation
option will be used for both userspace and kernel modules.

Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Signed-off-by: Prakash Surya <prakash.surya@delphix.com>
Closes #6605
(cherry picked from commit f1236ebf35d1531db75ac8a57b23e8fe48d6b780)
Signed-off-by: Fabian Gr√ºnbichler <f.gruenbichler@proxmox.com>
---
 config/zfs-build.m4 | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/config/zfs-build.m4 b/config/zfs-build.m4
index b84658a64..c695a882e 100644
--- a/config/zfs-build.m4
+++ b/config/zfs-build.m4
@@ -45,10 +45,11 @@ AC_DEFUN([ZFS_AC_DEBUG], [
 
 AC_DEFUN([ZFS_AC_DEBUGINFO_KERNEL], [
 	KERNELMAKE_PARAMS="$KERNELMAKE_PARAMS CONFIG_DEBUG_INFO=y"
+	KERNELCPPFLAGS="${KERNELCPPFLAGS} -fno-inline"
 ])
 
 AC_DEFUN([ZFS_AC_DEBUGINFO_USER], [
-	DEBUG_CFLAGS="$DEBUG_CFLAGS -g"
+	DEBUG_CFLAGS="${DEBUG_CFLAGS} -g -fno-inline"
 ])
 
 AC_DEFUN([ZFS_AC_DEBUGINFO], [
-- 
2.14.2

